<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Japanese Flashcards</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="favicon_io/android-chrome-192x192.png" />
  <meta name="theme-color" content="#6366f1" />
  <style>
    .flip-card {
      perspective: 1000px;
    }
    .flip-inner {
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }
    .flipped .flip-inner {
      transform: rotateY(180deg);
    }
    .flip-front,
    .flip-back {
      backface-visibility: hidden;
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      font-weight: bold;
      border-radius: 1rem;
      flex-direction: column;
    }
    .flip-back {
      transform: rotateY(180deg);
      background-color: #fef3c7;
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100">

  <div class="text-center w-full max-w-md px-4 space-y-6">


    <!-- Flashcard -->
    <div id="flashcard" class="relative w-full h-48 mx-auto flip-card cursor-pointer">
      <div class="flip-inner w-full h-full bg-white shadow-lg rounded-2xl relative">

        <!-- Front side -->
        <div id="cardFront" class="flip-front bg-white text-gray-800 relative">
          <div id="cardCounter"
               class="absolute top-2 right-2 text-sm text-gray-500 bg-white bg-opacity-80 px-2 py-1 rounded hidden">
             1 / 46
          </div>

          <span id="frontText" class="text-4xl mb-8">Press Start</span>
          <button id="speakBtn"
                  class="text-xl bg-purple-500 text-white rounded-full w-10 h-10 flex items-center justify-center shadow hover:bg-purple-600 hidden"
                  onclick="event.stopPropagation(); speakCurrent();"
                  title="Speak">
            üîä
          </button>
        </div>

        <!-- Back side -->
        <div id="cardBack" class="flip-back text-gray-900">
          -
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="flex justify-between">
    <input id="romajiInput" type="text" placeholder="Type Romaji (e.g. ka)"
      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-xl mr-2 hidden" />

    <div class="flex items-center justify-center">
      <button id="micBtn"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg flex items-center gap-2 hidden">
        üé§ Speak
      </button>
      <div id="speechResult" class="text-xl font-medium text-gray-800"></div>
    </div>

    </div>

    <div id="feedback" class="text-lg font-semibold h-6"></div>

    <div id="modeBox" class="space-y-2 text-left">
      <label class="block font-semibold">Choose mode:</label>
      <label class="inline-flex items-center gap-2 mr-4">
        <input type="radio" name="mode" value="hira" checked>
        Hiragana
      </label>
      <label class="inline-flex items-center gap-2 mr-4">
        <input type="radio" name="mode" value="kata">
        Katakana
      </label>
      <label class="inline-flex items-center gap-2">
        <input type="radio" name="mode" value="both">
        Both
      </label>
    </div>

    <div class="w-full h-3 rounded-full bg-gray-200 overflow-hidden">
      <div id="progressBar"
           class="h-full w-0 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 transition-all duration-300">
      </div>
    </div>
    <!-- Buttons -->
    <div class="flex justify-center gap-4 flex-wrap">
      <button id="startBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
        Start
      </button>
      <button id="backBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-2 rounded-lg hidden">
        Back
      </button>
      <button id="nextBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-2 rounded-lg hidden">
        Next
      </button>
      <button id="resetBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg hidden">
        Reset Game
      </button>
      <button id="replayBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-8 py-2 rounded-lg hidden">
        Replay
      </button>
    </div>
  </div>

  <script>
    const romaji = [
      'a', 'i', 'u', 'e', 'o',
      'ka', 'ki', 'ku', 'ke', 'ko',
      'sa', 'shi', 'su', 'se', 'so',
      'ta', 'chi', 'tsu', 'te', 'to',
      'na', 'ni', 'nu', 'ne', 'no',
      'ha', 'hi', 'fu', 'he', 'ho',
      'ma', 'mi', 'mu', 'me', 'mo',
      'ya', 'yu', 'yo',
      'ra', 'ri', 'ru', 're', 'ro',
      'wa', 'wo', 'n'
    ];

    const hiraganaMap = {
      a: '„ÅÇ', i: '„ÅÑ', u: '„ÅÜ', e: '„Åà', o: '„Åä',
      ka: '„Åã', ki: '„Åç', ku: '„Åè', ke: '„Åë', ko: '„Åì',
      sa: '„Åï', shi: '„Åó', su: '„Åô', se: '„Åõ', so: '„Åù',
      ta: '„Åü', chi: '„Å°', tsu: '„Å§', te: '„Å¶', to: '„Å®',
      na: '„Å™', ni: '„Å´', nu: '„Å¨', ne: '„Å≠', no: '„ÅÆ',
      ha: '„ÅØ', hi: '„Å≤', fu: '„Åµ', he: '„Å∏', ho: '„Åª',
      ma: '„Åæ', mi: '„Åø', mu: '„ÇÄ', me: '„ÇÅ', mo: '„ÇÇ',
      ya: '„ÇÑ', yu: '„ÇÜ', yo: '„Çà',
      ra: '„Çâ', ri: '„Çä', ru: '„Çã', re: '„Çå', ro: '„Çç',
      wa: '„Çè', wo: '„Çí', n: '„Çì'
    };

    const katakanaMap = {
      a: '„Ç¢', i: '„Ç§', u: '„Ç¶', e: '„Ç®', o: '„Ç™',
      ka: '„Ç´', ki: '„Ç≠', ku: '„ÇØ', ke: '„Ç±', ko: '„Ç≥',
      sa: '„Çµ', shi: '„Ç∑', su: '„Çπ', se: '„Çª', so: '„ÇΩ',
      ta: '„Çø', chi: '„ÉÅ', tsu: '„ÉÑ', te: '„ÉÜ', to: '„Éà',
      na: '„Éä', ni: '„Éã', nu: '„Éå', ne: '„Éç', no: '„Éé',
      ha: '„Éè', hi: '„Éí', fu: '„Éï', he: '„Éò', ho: '„Éõ',
      ma: '„Éû', mi: '„Éü', mu: '„É†', me: '„É°', mo: '„É¢',
      ya: '„É§', yu: '„É¶', yo: '„É®',
      ra: '„É©', ri: '„É™', ru: '„É´', re: '„É¨', ro: '„É≠',
      wa: '„ÉØ', wo: '„É≤', n: '„É≥'
    };

    let shuffledArray = [];
    let index = 0;
    let mode = 'hira';

    const flashcard = document.getElementById("flashcard");
    const frontText = document.getElementById("frontText");
    const cardBack = document.getElementById("cardBack");
    const startBtn = document.getElementById("startBtn");
    const modeBox = document.getElementById("modeBox");
    const nextBtn = document.getElementById("nextBtn");
    const resetBtn = document.getElementById("resetBtn");
    const backBtn = document.getElementById("backBtn");
    const replayBtn = document.getElementById("replayBtn");
    const romajiInput = document.getElementById("romajiInput");
    const feedback = document.getElementById("feedback");
    const cardCounter = document.getElementById('cardCounter');
    const progressBar = document.getElementById('progressBar')
    const speakBtn = document.getElementById('speakBtn');
    const micBtn = document.getElementById("micBtn");


    flashcard.addEventListener("click", () => {
      flashcard.classList.toggle("flipped");
    });

    function startFlashcards() {
      const selected = document.querySelector('input[name="mode"]:checked');
      mode = selected ? selected.value : 'hira';
      shuffledArray = [...romaji].sort(() => Math.random() - 0.5);
      index = 1;
      showCard();
      startBtn.classList.add("hidden");
      nextBtn.classList.remove("hidden");
      backBtn.classList.remove("hidden");
      resetBtn.classList.remove("hidden");
      romajiInput.classList.remove("hidden");
    }

    function showCard() {
      const current = shuffledArray[index];

      let text = '';
      if (mode === 'hira') {
        text = hiraganaMap[current];
      } else if (mode === 'kata') {
        text = katakanaMap[current];
      } else {
        text = `${hiraganaMap[current]} / ${katakanaMap[current]}`;
      }

      frontText.textContent = text;
      cardBack.textContent = current;
      romajiInput.value = "";
      feedback.textContent = "";
      flashcard.classList.remove("flipped");
      romajiInput.focus();

      // üëá Show speak button only after the first card
      const speakBtn = document.getElementById("speakBtn");
      if (index === 0 || index >= romaji.length - 1) {
        speakBtn.classList.add("hidden");
        cardCounter.classList.add("hidden");
        resetBtn.classList.remove("hidden");
      } else {
        speakBtn.classList.remove("hidden");
        cardCounter.classList.remove("hidden");
        micBtn.classList.remove("hidden");
      }

      if (index > 0) {
        modeBox.classList.add("hidden");
      }

      cardCounter.textContent = `Card ${index} of ${shuffledArray.length}`;
      const percent = ((index + 1) / shuffledArray.length) * 100;
      progressBar.style.width = `${percent}%`;
    }


    function checkAnswer() {
      const current = shuffledArray[index];
      const userInput = romajiInput.value.trim().toLowerCase();
      const isCorrect = userInput === current;

      if (!isCorrect) {
        feedback.textContent = `‚ùå Correct answer is: ${current}`;
        feedback.className = "text-red-600 font-bold";
      } else {
        feedback.textContent = "";
      }

      return isCorrect;
    }

    nextBtn.addEventListener("click", () => {
      if (checkAnswer()) {
        if (index < shuffledArray.length - 1) {
          index++;
          showCard();
        } else {
          frontText.textContent = "üéâ Done!";
          cardBack.textContent = "üëè";
          nextBtn.disabled = true;
          replayBtn.classList.remove("hidden");
          romajiInput.classList.add("hidden");
        }
      }
    });

    backBtn.addEventListener("click", () => {
      if (index > 0) {
        index--;
        showCard();
      }
    });

    replayBtn.addEventListener("click", startFlashcards);
    startBtn.addEventListener("click", startFlashcards);

    romajiInput.addEventListener("keydown", e => {
      if (e.key === "Enter") nextBtn.click();
    });

    function speakCurrent() {
      const current = shuffledArray[index];
      if (!current) return;

      let text = '';
      if (mode === 'hira') {
        text = hiraganaMap[current];
      } else {
        text = `${katakanaMap[current]}`;
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ja-JP';
      const voices = speechSynthesis.getVoices();
      const jp = voices.find(v => v.lang === 'ja-JP');
      if (jp) utterance.voice = jp;
      speechSynthesis.cancel();
      speechSynthesis.speak(utterance);
    }

    resetBtn.addEventListener("click", () => {
      index = 0;
      shuffledArray = [];
      flashcard.classList.remove("flipped");
      frontText.textContent = "Press Start";
      cardBack.textContent = "-";
      romajiInput.value = "";
      romajiInput.classList.add("hidden");
      feedback.textContent = "";
      progressBar.style.width = "0%";
      speakBtn.classList.add("hidden");
      document.getElementById('cardCounter').textContent = `Card 0 of 0`;

      // Show start again, hide all others
      startBtn.classList.remove("hidden");
      nextBtn.classList.add("hidden");
      backBtn.classList.add("hidden");
      resetBtn.classList.add("hidden");
      replayBtn.classList.add("hidden");
      cardCounter.classList.add("hidden");
      modeBox.classList.remove("hidden");
    });



    // speech recognize setting permission
    function validateSpokenAnswer(userInput) {
      const current = shuffledArray[index];
      const isCorrect = userInput === current;

      if (isCorrect) {
        feedback.textContent = "‚úÖ Correct!";
        feedback.className = "text-green-600 font-bold";
        setTimeout(() => {
          if (index < shuffledArray.length - 1) {
            index++;
            showCard();
          } else {
            frontText.textContent = "üéâ Done!";
            cardBack.textContent = "üëè";
            nextBtn.disabled = true;
            replayBtn.classList.remove("hidden");
            micBtn.classList.add("hidden");
          }
        }, 600);
      } else {
        feedback.textContent = `‚ùå Incorrect! Expected: ${current}`;
        feedback.className = "text-red-600 font-bold";
      }
    }

    micBtn.addEventListener("click", () => {
      if (recognition && !isRecognizing) {
        recognition.start();
      }
    });
    let recognition;
    let isRecognizing = false;

    // Setup Web Speech API
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        isRecognizing = true;
        micBtn.textContent = "üéôÔ∏è Listening...";
      };

      recognition.onend = () => {
        isRecognizing = false;
        micBtn.textContent = "üé§ Speak";
      };

      recognition.onerror = (event) => {
        feedback.textContent = "‚ùå Speech error: " + event.error;
        feedback.className = "text-red-600 font-bold";
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim().toLowerCase();
        document.getElementById("speechResult").textContent = transcript;
        validateSpokenAnswer(transcript);
      };
    } else {
      micBtn.disabled = true;
      micBtn.textContent = "üé§";
      micBtn.classList.add("bg-gray-600");
      micBtn.classList.add("hover:bg-gray-700");
    }


    window.speechSynthesis.onvoiceschanged = () => {
      speechSynthesis.getVoices();
    };
    
    if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log("‚úÖ Service Worker registered"))
      .catch(err => console.error("‚ùå SW registration failed:", err));
  }
  </script>
</body>
</html>
